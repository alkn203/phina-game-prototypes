<!doctype html>
 
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <title>Forked: Match 3</title>
    <meta name="description" content="${description}" />
    
    <style>*, *:before, *:after {
  box-sizing: border-box; 
}
html {
  font-size: 62.5%;
}
body {
  color: #444;
  background-color: hsl(0, 0%, 96%);
}
h1 {
  font-size: 1.8rem;
}

</style>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/gh/phinajs/phina.js@v0.2.3/build/phina.js"></script>
    <script>phina.globalize();
// アセット
const ASSETS = {
  // 画像
  image: {
    'gem': 'https://cdn.jsdelivr.net/gh/alkn203/phina-game-prototypes@main/match3/assets/gem.png',
  },
};
// 定数
const SCREEN_WIDTH = 640;
const SCREEN_HEIGHT = 640;
const GEM_SIZE = 80;
const GEM_NUM_X = 8;
const GEM_NUM_Y = GEM_NUM_X * 2;
const GEM_NUM = GEM_NUM_X * GEM_NUM_X;
const GEM_OFFSET = GEM_SIZE / 2;
// メインシーン
phina.define('MainScene', {
  superClass: 'DisplayScene',
  // コンストラクタ
  init: function() {
    // 親クラス初期化
    this.superInit({
      width: SCREEN_WIDTH,
      height: SCREEN_HEIGHT,
    });
    // 背景色
    this.backgroundColor = 'black'; 
    // グリッド
    var grid = Grid(SCREEN_WIDTH, GEM_NUM_X);
    // グループ
    var gemGroup = DisplayElement().addChildTo(this);
    this.dummyGroup = DisplayElement().addChildTo(this);
    this.cursorGroup = DisplayElement().addChildTo(this);
    // ペア
    this.pair = [];
    // ジェム配置
    GEM_NUM.times((i) => {
      var sx = i % GEM_NUM_X;
      var sy = Math.floor(i / GEM_NUM_X);
      
      var gem = Gem().addChildTo(gemGroup);
      gem.x = grid.span(sx) + GEM_OFFSET;
      gem.y = grid.span(sy) + GEM_OFFSET;
      gem.dropCnt = 0;
    });
    // 参照用
    this.gemGroup = gemGroup;
    this.grid = grid;
    //ジェム初期化
    this.initGem();
  },
  // ジェム初期化
  initGem: function() {
    // 3つ並び以上があれば仕切り直し
    if (this.isExistMatch3()) {
      this.gemGroup.children.each((gem) => {
        // ランダムな色
        gem.num = Random.randint(0, 6);
        gem.frameIndex = gem.num; 
        gem.mark = "normal";
      });
      this.initGem();
    }
    // 画面外ジェム配置
    this.initHiddenGem();
  },
  // 画面外のジェム配置
  initHiddenGem: function() {
    var self = this;
    // 一旦消す
    this.gemGroup.children.eraseIfAll((gem) => {
      if (gem.y < 0) {
        return true;
      }
    });
    
    GEM_NUM_X.times(function(spanX) {
      GEM_NUM_X.times(function(spanY) {
        var gem = Gem().addChildTo(self.gemGroup);
        gem.num = Random.randint(0, 6);
        gem.frameIndex = gem.num; 
        gem.mark = "normal";
        gem.x = self.grid.span(spanX) + GEM_OFFSET;
        // 一画面文分上にずらす
        gem.y = self.grid.span(spanY) + GEM_OFFSET - SCREEN_HEIGHT;
        gem.dropCnt = 0;
      });
    });
  },
  // ペアの選択処理
  selectPair:function(gem) {
    // 一つ目
    if (this.pair.length === 0) {
      // カーソル表示
      var cursor1 = Cursor().addChildTo(this.cursorGroup);
      cursor1.setPosition(gem.x, gem.y);
      this.pair.push(gem);
      // 隣り合わせ以外を選択不可にする
      this.selectableNext();
      return;
    }
    // 二つ目
    if (this.pair.length === 1) {
      cursor2 = Cursor().addChildTo(this.cursorGroup);
      cursor2.setPosition(gem.x, gem.y);
      this.pair.push(gem);
      // 入れ替え処理
      this.swapGem(false);
    }
  },
  // 隣り合わせ以外を選択不可にする
  selectableNext: function() {
    var gem = this.pair[0];
    // 一旦全てを選択不可に
    this.gemGroup.children.each(function(gem) {
      gem.setInteractive(false);
    });
    
    this.gemGroup.children.each(function(target) {
      var dx = Math.abs(gem.x - target.x);
      var dy = Math.abs(gem.y - target.y);
      // 上下左右隣り合わせだけを選択可に
      if (gem.x === target.x && dy === GEM_SIZE) {
        target.setInteractive(true);
      }
      if (gem.y === target.y && dx === GEM_SIZE) {
        target.setInteractive(true);
      }
    });
  },
  // ジェム入れ替え処理
  swapGem: function(second) {
    var g1 = this.pair[0];
    var g2 = this.pair[1];
    var self = this;
    // 1回目
    if (!second) {
      this.setGemSelectable(false);
      this.cursorGroup.children.clear();
    }
    // flowで非同期処理
    var flows = [];
    
    var flow1 = Flow(function(resolve) {
      // 入れ替えアニメーション
      g1.tweener.updateType = 'normal';
      g1.tweener.to({x: g2.x, y: g2.y}, 200)
        .call(function() {
          resolve();
        }).play();
    });
    var flow2 = Flow(function(resolve) {
      g2.tweener.updateType = 'normal';
      g2.tweener.to({x: g1.x, y: g1.y}, 200)
        .call(function() {
          resolve();
        }).play();
    });
    
    flows.push(flow1);
    flows.push(flow2);
    // 入れ替え後処理
    Flow.all(flows).then(function(message) {
      if (second) {
        self.pair.clear();
        self.setGemSelectable(true);
      }
      else {
        //  3つ並びがあれば削除処理へ
        if (self.isExistMatch3()) {
          self.pair.clear();
          self.removeGems();
        }
        else {
          // 戻りの入れ替え
          self.swapGem(true);
        }
      }
    });
  },
  // 3つ並び以上存在チェック
  isExistMatch3: function() {
    this.gemGroup.children.each(function(gem) {
      // 画面に見えているジェムのみ
      if (gem.y > 0) {
        // 横方向
        this.checkHorizontal(gem);
        this.setMark();
        // 縦方向
        this.checkVertical(gem);
        this.setMark();
      }
    }, this);
    
    var result = false;
    
    this.gemGroup.children.some(function(gem) {
      // 削除対象があれば
      if (gem.mark === "rmv") {
        result = true;
        return true;
      }
    }, this);
    
    return result;
  },
  // 横方向の3つ並び以上チェック
  checkHorizontal: function(current) {
    if (current.mark !== "rmv") {
      current.mark = "tmp";
    }

    this.cnt++;
    var next = this.getGem(Vector2(current.x + GEM_SIZE, current.y));
    if (next && current.num === next.num) {
      this.checkHorizontal(next);
    }
  },
  // 縦方向の3つ並び以上チェック
  checkVertical: function(current) {
    if (current.mark !== "rmv") {
      current.mark = "tmp";
    }

    this.cnt++;
    var next = this.getGem(Vector2(current.x, current.y + GEM_SIZE));
    if (next && current.num === next.num) {
      this.checkVertical(next);
    }
  },
  // マークセット
  setMark: function() {
    this.gemGroup.children.each(function(gem) {
      if (gem.mark === "tmp") {
        // 3つ並び以上なら削除マーク
        if (this.cnt > 2) {
          gem.mark = "rmv";
        } else {
          gem.mark = "normal";
        }
      }
    }, this);
    
    this.cnt = 0;
  },
  // ジェムの削除処理
  removeGems: function() {
    var self = this;

    this.gemGroup.children.each(function(gem) {
      if (gem.mark === "rmv") {
        // 削除対象ジェムより上にあるジェムに落下回数をセット
        self.gemGroup.children.each(function(target) {
          if (target.y < gem.y && target.x === gem.x) {
            target.dropCnt++;
          }
        });
        // 消去アニメーション用ダミー作成
        var dummy = Gem().addChildTo(self.dummyGroup);
        dummy.setPosition(gem.x, gem.y);
        dummy.fill = gem.fill;
      }
    });
    // ジェム削除
    this.gemGroup.children.eraseIfAll(function(gem) {
      if (gem.mark === "rmv") {
        return true;
      }
    });
    var flows = [];
    // flowで非同期処理
    this.dummyGroup.children.each(function(dummy) {
      var flow = Flow(function(resolve) {
        dummy.tweener
             .to({scaleX: 0.2, scaleY: 0.2, ahpha: 0.2}, 200)
             .call(function() {
               dummy.remove();
               resolve('removed');
             }).play();
      });
      flows.push(flow);
    });
    
    Flow.all(flows).then(function(message) {
      self.dropGems();
    });
  },
  // ジェムの落下処理
  dropGems: function() {
    var self = this;
    
    var flows = [];
    this.gemGroup.children.each(function(gem) {
      // 落下フラグがあるジェムを落下させる
      if (gem.dropCnt > 0) {
        // 落下アニメーション
        var flow = Flow(function(resolve) {
          gem.tweener.updateType = 'normal';
          gem.tweener.by({y: gem.dropCnt * GEM_SIZE}, gem.dropCnt * 300)
                     .call(function() {
                        gem.dropCnt = 0;
                        resolve('dropped');
                     }).play();
          
        });
        flows.push(flow);
      }
    });

    Flow.all(flows).then(function(message) {
      // 画面外のジェムを作り直す
      self.initHiddenGem();
      // 3並び再チェック
      if (self.isExistMatch3()) {
        self.removeGems();
      }
      else {
        self.setGemSelectable(true);
      }
    });
  },
  // 指定された位置のジェムを返す
  getGem: function(pos) {
    var result = null;
    // 該当するジェムがあったらループを抜ける
    this.gemGroup.children.some(function(gem) {
      if (gem.position.equals(pos)) {
        result = gem;
        return true;
      }
    });
    return result;
  },
  // ジェムを選択可能にする
  setGemSelectable: function(b) {
    this.gemGroup.children.each(function(gem) {
      gem.setInteractive(b);
    });
  },
});
// ジェムクラス
phina.define('Gem', {
  // Spriteを継承
  superClass: 'Sprite',
    // コンストラクタ
    init: function() {
      // 親クラス初期化
      this.superInit('gem', GEM_SIZE, GEM_SIZE);
      this.setInteractive(true);
    },
    // タッチされた時
    onpointend: function() {
      this.parent.parent.selectPair(this);
    },
});
// カーソルクラス
phina.define('Cursor', {
  // RectangleShapeを継承
  superClass: 'RectangleShape',
    // コンストラクタ
    init: function() {
      // 親クラス初期化
      this.superInit({
        width: GEM_SIZE,
        height: GEM_SIZE,
        fill: null,
        stroke: 'red',
      });
    },
});
// メイン
phina.main(function() {
  var app = GameApp({
    startLabel: 'main',
    width: SCREEN_WIDTH,
    height: SCREEN_HEIGHT,
    assets: ASSETS,
  });
  app.run();
});</script>
  </body>
</html>

